<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Nginx on 暮鼓晨钟</title><link>https://caijemmy.github.io/tags/nginx/</link><description>Recent content in Nginx on 暮鼓晨钟</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Wed, 24 Jul 2024 00:00:00 +0000</lastBuildDate><atom:link href="https://caijemmy.github.io/tags/nginx/index.xml" rel="self" type="application/rss+xml"/><item><title>1.0 nginx</title><link>https://caijemmy.github.io/p/1.0-nginx/</link><pubDate>Wed, 24 Jul 2024 00:00:00 +0000</pubDate><guid>https://caijemmy.github.io/p/1.0-nginx/</guid><description>&lt;img src="https://caijemmy.github.io/p/1.0-nginx/cover.jpg" alt="Featured image of post 1.0 nginx" />&lt;h2 id="nginx-安装">nginx 安装
&lt;/h2>&lt;p>常用版本4大阵营&lt;/p>
&lt;ul>
&lt;li>Nginx开源版本：&lt;a class="link" href="https://nginx.org/" target="_blank" rel="noopener"
>nginx&lt;/a>&lt;/li>
&lt;li>Nginx plus 商业版：&lt;a class="link" href="https://www.f5.com/go/product/welcome-to-nginx" target="_blank" rel="noopener"
>Welcome to F5 NGINX&lt;/a>&lt;/li>
&lt;li>openresty：&lt;a class="link" href="https://openresty.org/cn/" target="_blank" rel="noopener"
>OpenResty® - 开源官方站&lt;/a>&lt;/li>
&lt;li>Tengine：&lt;a class="link" href="https://tengine.taobao.org/" target="_blank" rel="noopener"
>The Tengine Web Server&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>安装参考链接：&lt;a class="link" href="https://nginx.org/en/linux_packages.html#Debian" target="_blank" rel="noopener"
>nginx：Linux 软件包&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 前提条件&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo apt install curl gnupg2 ca-certificates lsb-release debian-archive-keyring
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 导入官方 nginx 签名密钥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl https://nginx.org/keys/nginx_signing.key &lt;span class="p">|&lt;/span> gpg --dearmor &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> &lt;span class="p">|&lt;/span> sudo tee /usr/share/keyrings/nginx-archive-keyring.gpg &amp;gt;/dev/null
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 验证下载的文件是否包含正确的密钥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:~# gpg --dry-run --quiet --no-keyring --import --import-options import-show /usr/share/keyrings/nginx-archive-keyring.gpg
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pub rsa4096 2024-05-29 &lt;span class="o">[&lt;/span>SC&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 8540A6F18833A80E9C1653A42FD21310B49F6B46
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">uid nginx signing key &amp;lt;signing-key-2@nginx.com&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pub rsa2048 2011-08-19 &lt;span class="o">[&lt;/span>SC&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>expires: 2027-05-24&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 573BFD6B3D8FBC641079A6ABABF5BD827BD9BF62
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">uid nginx signing key &amp;lt;signing-key@nginx.com&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pub rsa4096 2024-05-29 &lt;span class="o">[&lt;/span>SC&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 9E9BE90EACBCDE69FE9B204CBCDCD8A38D88A2B3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">uid nginx signing key &amp;lt;signing-key-3@nginx.com&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 为稳定的 nginx 软件包设置 apt 存储库&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] \
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">http://nginx.org/packages/debian `lsb_release -cs` nginx&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> &lt;span class="p">|&lt;/span> sudo tee /etc/apt/sources.list.d/nginx.list
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 安装 nginx&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo apt update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo apt install nginx
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="nginx-启动及验证">nginx 启动及验证
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 启动&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:~# /usr/sbin/nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:~# ps -ef&lt;span class="p">|&lt;/span>grep nginx &lt;span class="p">|&lt;/span> grep -v grep
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root &lt;span class="m">6683&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> 19:54 ? 00:00:00 nginx: master process /usr/sbin/nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx &lt;span class="m">6684&lt;/span> &lt;span class="m">6683&lt;/span> &lt;span class="m">0&lt;/span> 19:54 ? 00:00:00 nginx: worker process
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx &lt;span class="m">6685&lt;/span> &lt;span class="m">6683&lt;/span> &lt;span class="m">0&lt;/span> 19:54 ? 00:00:00 nginx: worker process
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx &lt;span class="m">6686&lt;/span> &lt;span class="m">6683&lt;/span> &lt;span class="m">0&lt;/span> 19:54 ? 00:00:00 nginx: worker process
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx &lt;span class="m">6687&lt;/span> &lt;span class="m">6683&lt;/span> &lt;span class="m">0&lt;/span> 19:54 ? 00:00:00 nginx: worker process
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>vmware 上配置本地端口到虚机端口的映射&lt;/li>
&lt;li>虚机上如果有防火墙，注意防火墙的配置&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="https://caijemmy.github.io/p/1.0-nginx/image-nginx%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E6%88%90%E5%8A%9F.png"
width="1134"
height="406"
srcset="https://caijemmy.github.io/p/1.0-nginx/image-nginx%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E6%88%90%E5%8A%9F_hu_91a04b10d8fb7700.png 480w, https://caijemmy.github.io/p/1.0-nginx/image-nginx%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E6%88%90%E5%8A%9F_hu_69a4874d1e3ba54f.png 1024w"
loading="lazy"
alt="image-nginx服务启动成功"
class="gallery-image"
data-flex-grow="279"
data-flex-basis="670px"
>&lt;/p>
&lt;h3 id="配置启动服务">配置启动服务
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查看/lib/systemd/system/nginx.service 或 /usr/lib/systemd/system/nginx.service 文件是否存在&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 注意安装路径的修改&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Unit&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">Description&lt;/span>&lt;span class="o">=&lt;/span>nginx - high performance web server
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">Documentation&lt;/span>&lt;span class="o">=&lt;/span>https://nginx.org/en/docs/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">After&lt;/span>&lt;span class="o">=&lt;/span>network-online.target remote-fs.target nss-lookup.target
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">Wants&lt;/span>&lt;span class="o">=&lt;/span>network-online.target
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Service&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">Type&lt;/span>&lt;span class="o">=&lt;/span>forking
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">PIDFile&lt;/span>&lt;span class="o">=&lt;/span>/run/nginx.pid
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">Environment&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;CONFFILE=/etc/nginx/nginx.conf&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">EnvironmentFile&lt;/span>&lt;span class="o">=&lt;/span>-/etc/default/nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">ExecStart&lt;/span>&lt;span class="o">=&lt;/span>/usr/sbin/nginx -c &lt;span class="si">${&lt;/span>&lt;span class="nv">CONFFILE&lt;/span>&lt;span class="si">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">ExecReload&lt;/span>&lt;span class="o">=&lt;/span>/bin/sh -c &lt;span class="s2">&amp;#34;/bin/kill -s HUP &lt;/span>&lt;span class="k">$(&lt;/span>/bin/cat /run/nginx.pid&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">ExecStop&lt;/span>&lt;span class="o">=&lt;/span>/bin/sh -c &lt;span class="s2">&amp;#34;/bin/kill -s TERM &lt;/span>&lt;span class="k">$(&lt;/span>/bin/cat /run/nginx.pid&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">ExecQuit&lt;/span>&lt;span class="o">=&lt;/span>/bin/sh -c &lt;span class="s2">&amp;#34;/bin/kill -s QUIT &lt;/span>&lt;span class="k">$(&lt;/span>/bin/cat /run/nginx.pid&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Install&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">WantedBy&lt;/span>&lt;span class="o">=&lt;/span>multi-user.target
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查看服务是否可用，开机自启动&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl daemon-reload
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl status nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">systemctl &lt;span class="nb">enable&lt;/span> nginx
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="nginx-常用命令">nginx 常用命令
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查看版本&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:~# nginx -v
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx version: nginx/1.28.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 停止命令&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:~# nginx -s stop
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:~# ps -ef&lt;span class="p">|&lt;/span>grep nginx &lt;span class="p">|&lt;/span> grep -v grep
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 启动命令&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:~# /usr/sbin/nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:~# ps -ef&lt;span class="p">|&lt;/span>grep nginx &lt;span class="p">|&lt;/span> grep -v grep
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root &lt;span class="m">6797&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> 20:21 ? 00:00:00 nginx: master process /usr/sbin/nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx &lt;span class="m">6798&lt;/span> &lt;span class="m">6797&lt;/span> &lt;span class="m">0&lt;/span> 20:21 ? 00:00:00 nginx: worker process
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx &lt;span class="m">6799&lt;/span> &lt;span class="m">6797&lt;/span> &lt;span class="m">0&lt;/span> 20:21 ? 00:00:00 nginx: worker process
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx &lt;span class="m">6800&lt;/span> &lt;span class="m">6797&lt;/span> &lt;span class="m">0&lt;/span> 20:21 ? 00:00:00 nginx: worker process
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx &lt;span class="m">6801&lt;/span> &lt;span class="m">6797&lt;/span> &lt;span class="m">0&lt;/span> 20:21 ? 00:00:00 nginx: worker process
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 配置重新加载&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:~# /usr/sbin/nginx -s reload
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:~# ps -ef&lt;span class="p">|&lt;/span>grep nginx &lt;span class="p">|&lt;/span> grep -v grep
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root &lt;span class="m">6797&lt;/span> &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> 20:21 ? 00:00:00 nginx: master process /usr/sbin/nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx &lt;span class="m">6809&lt;/span> &lt;span class="m">6797&lt;/span> &lt;span class="m">0&lt;/span> 20:23 ? 00:00:00 nginx: worker process
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx &lt;span class="m">6810&lt;/span> &lt;span class="m">6797&lt;/span> &lt;span class="m">0&lt;/span> 20:23 ? 00:00:00 nginx: worker process
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx &lt;span class="m">6811&lt;/span> &lt;span class="m">6797&lt;/span> &lt;span class="m">0&lt;/span> 20:23 ? 00:00:00 nginx: worker process
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx &lt;span class="m">6812&lt;/span> &lt;span class="m">6797&lt;/span> &lt;span class="m">0&lt;/span> 20:23 ? 00:00:00 nginx: worker process
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 配置默认路径&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:~# ls -l /etc/nginx/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total &lt;span class="m">28&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">4096&lt;/span> May &lt;span class="m">17&lt;/span> 19:39 conf.d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">1007&lt;/span> Apr &lt;span class="m">23&lt;/span> 07:48 fastcgi_params
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">5349&lt;/span> Apr &lt;span class="m">23&lt;/span> 07:48 mime.types
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">22&lt;/span> Apr &lt;span class="m">23&lt;/span> 08:39 modules -&amp;gt; /usr/lib/nginx/modules
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">644&lt;/span> Apr &lt;span class="m">23&lt;/span> 08:39 nginx.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">636&lt;/span> Apr &lt;span class="m">23&lt;/span> 07:48 scgi_params
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">664&lt;/span> Apr &lt;span class="m">23&lt;/span> 07:48 uwsgi_params
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="停止nginx的其他方式">停止nginx的其他方式
&lt;/h3>&lt;p>参考链接：&lt;a class="link" href="https://nginx.org/en/docs/beginners_guide.html" target="_blank" rel="noopener"
>Beginner’s Guide&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># to stop nginx processes with waiting for the worker processes to finish serving current requests&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx -s quit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 通过 kill 命令&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> -f /var/run/nginx.pid &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> cat /var/run/nginx.pid &lt;span class="p">|&lt;/span> xargs &lt;span class="nb">kill&lt;/span> -s QUIT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 查看nginx资源使用情况&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ps axw -o pid,ppid,user,%cpu,vsz,wchan,command &lt;span class="p">|&lt;/span> egrep &lt;span class="s1">&amp;#39;(nginx|PID)&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="配置文件">配置文件
&lt;/h2>&lt;p>指令种类：简单指令，块指令。&lt;/p>
&lt;p>全局块：就是最开始的简单指令。从配置文件开始到events&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">user nginx&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_processes auto&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">error_log /var/log/nginx/error.log notice&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pid /run/nginx.pid&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>events块：配置服务器和用户网络连接相关的参数。&lt;/p>
&lt;p>http块：配置代理、缓存、日志及第三方模块等。&lt;/p>
&lt;h3 id="最小化配置文件">最小化配置文件
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># cat /etc/nginx/nginx.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">user nginx&lt;span class="p">;&lt;/span> &lt;span class="c1"># worker进程启动时以哪个用户启动，限制 worker 进程的权限，提高安全性。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">worker_processes auto&lt;span class="p">;&lt;/span> &lt;span class="c1"># 启动nginx时，启动多少个worker进程，设置为 CPU 核心数或 2 倍 CPU 核心数。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">error_log /var/log/nginx/error.log notice&lt;span class="p">;&lt;/span> &lt;span class="c1"># 指定错误日志的路径和日志级别。notice 表示记录 notice 级别及以上的日志（如 notice、warn、error）。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pid /run/nginx.pid&lt;span class="p">;&lt;/span> &lt;span class="c1"># 指定存储 Nginx 主进程 PID 的文件路径。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">events &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> worker_connections 1024&lt;span class="p">;&lt;/span> &lt;span class="c1"># 设置每个 worker 进程的最大连接数。总并发连接数 = worker_processes × worker_connections。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">http &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> include /etc/nginx/mime.types&lt;span class="p">;&lt;/span> &lt;span class="c1"># 包含MIME类型配置文件&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> default_type application/octet-stream&lt;span class="p">;&lt;/span> &lt;span class="c1"># 默认的MIME类型&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> log_format main &lt;span class="s1">&amp;#39;$remote_addr - $remote_user [$time_local] &amp;#34;$request&amp;#34; &amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;$status $body_bytes_sent &amp;#34;$http_referer&amp;#34; &amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;&amp;#34;$http_user_agent&amp;#34; &amp;#34;$http_x_forwarded_for&amp;#34;&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1"># 定义日志格式。main 是日志格式的名称，后面是具体的格式字符串。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> access_log /var/log/nginx/access.log main&lt;span class="p">;&lt;/span> &lt;span class="c1"># 指定访问日志的路径和日志格式。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sendfile on&lt;span class="p">;&lt;/span> &lt;span class="c1"># 启用 sendfile 机制，直接通过内核发送文件，减少用户态和内核态之间的数据拷贝。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#tcp_nopush on; # 启用 TCP_NOPUSH 选项，确保数据包填满后再发送&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> keepalive_timeout 65&lt;span class="p">;&lt;/span> &lt;span class="c1"># 设置客户端保持连接的超时时间（单位为秒）。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#gzip on; # 启用 gzip 压缩&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> include /etc/nginx/conf.d/*.conf&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># /etc/nginx/conf.d/default.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># server 块可以是多个&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">server &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> listen 80&lt;span class="p">;&lt;/span> &lt;span class="c1"># 指定 Nginx 监听的端口号。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server_name localhost&lt;span class="p">;&lt;/span> &lt;span class="c1"># 指定服务器的域名或主机名。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#access_log /var/log/nginx/host.access.log main;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># location 块可以是多个&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> location / &lt;span class="o">{&lt;/span> &lt;span class="c1"># 定义根路径（/）的请求处理规则。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> root /usr/share/nginx/html&lt;span class="p">;&lt;/span> &lt;span class="c1"># 指定根路径的静态文件存储目录。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> index index.html index.htm&lt;span class="p">;&lt;/span> &lt;span class="c1"># 指定默认的索引文件。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#error_page 404 /404.html;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># redirect server error pages to the static page /50x.html&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> error_page &lt;span class="m">500&lt;/span> &lt;span class="m">502&lt;/span> &lt;span class="m">503&lt;/span> &lt;span class="m">504&lt;/span> /50x.html&lt;span class="p">;&lt;/span> &lt;span class="c1"># 定义当服务器返回 500、502、503 或 504 错误时，重定向到 /50x.html 页面。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">location&lt;/span> &lt;span class="o">=&lt;/span> /50x.html &lt;span class="o">{&lt;/span> &lt;span class="c1"># 定义 /50x.html 路径的请求处理规则。= 表示精确匹配。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> root /usr/share/nginx/html&lt;span class="p">;&lt;/span> &lt;span class="c1"># 指定 /50x.html 文件的存储目录。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># proxy the PHP scripts to Apache listening on 127.0.0.1:80&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#location ~ \.php$ { # 匹配所有以 .php 结尾的请求路径。~ 表示正则表达式匹配。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># proxy_pass http://127.0.0.1; # 将 PHP 请求代理到 http://127.0.0.1（通常是 Apache 服务器）。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#location ~ \.php$ { # 匹配所有以 .php 结尾的请求路径。~ 表示正则表达式匹配。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># root html; # 指定根路径的静态文件存储目录。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># fastcgi_pass 127.0.0.1:9000; # 将 PHP 请求转发给 FastCGI 服务器（如 PHP-FPM）处理。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># fastcgi_index index.php; # 指定FastCGI 服务器默认的索引文件。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># fastcgi_param SCRIPT_FILENAME /scripts$fastcgi_script_name; # 设置 FastCGI 参数，指定 PHP 脚本的路径。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># include fastcgi_params; # 包含 FastCGI 的默认参数配置文件。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># deny access to .htaccess files, if Apache&amp;#39;s document root&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># concurs with nginx&amp;#39;s one&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#location ~ /\.ht { # 匹配所有以 .ht 开头的文件路径（如 .htaccess）。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># deny all; # 禁止访问匹配的文件。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">#}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="反向代理">反向代理
&lt;/h2>&lt;h3 id="单台代理">单台代理
&lt;/h3>&lt;h4 id="目标">目标
&lt;/h4>&lt;ul>
&lt;li>在浏览器访问一个地址: http://127.0.0.1:3000/。&lt;/li>
&lt;li>Nginx接受上面的请求。&lt;/li>
&lt;li>转发请求到tomcat。&lt;/li>
&lt;li>tomcat响应一个页面，页面中有：&amp;ldquo;tomcat hello !!!&amp;quot;。&lt;/li>
&lt;/ul>
&lt;h4 id="操作步骤1安装tomcat">操作步骤1：安装tomcat
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 安装java&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo apt install openjdk-17-jdk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 安装tomcat&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:~# wget https://dlcdn.apache.org/tomcat/tomcat-11/v11.0.7/bin/apache-tomcat-11.0.7.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:~# sudo tar -xzf apache-tomcat-11.0.7.tar.gz -C /opt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:~# sudo mv /opt/apache-tomcat-11.0.7/ /opt/tomcat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 配置环境变量&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat# vim /etc/profile
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> -d /opt/tomcat &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">export&lt;/span> &lt;span class="nv">CATALINA_HOME&lt;/span>&lt;span class="o">=&lt;/span>/opt/tomcat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">export&lt;/span> &lt;span class="nv">PATH&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$PATH&lt;/span>:&lt;span class="nv">$CATALINA_HOME&lt;/span>/bin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 创建tomcat用户&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat# sudo useradd -r -m -U -d /opt/tomcat -s /bin/false tomcat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">useradd: warning: the home directory /opt/tomcat already exists.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">useradd: Not copying any file from skel directory into it.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat#
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat# sudo chown -R tomcat: /opt/tomcat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 配置tomcat服务&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat# vim /etc/systemd/system/tomcat.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Unit&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">Description&lt;/span>&lt;span class="o">=&lt;/span>Apache Tomcat Web Application Container
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">After&lt;/span>&lt;span class="o">=&lt;/span>network.target
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Service&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">Type&lt;/span>&lt;span class="o">=&lt;/span>forking
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">User&lt;/span>&lt;span class="o">=&lt;/span>tomcat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">Group&lt;/span>&lt;span class="o">=&lt;/span>tomcat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">Environment&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">Environment&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;CATALINA_PID=/opt/tomcat/temp/tomcat.pid&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">Environment&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;CATALINA_HOME=/opt/tomcat&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">Environment&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;CATALINA_BASE=/opt/tomcat&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">ExecStart&lt;/span>&lt;span class="o">=&lt;/span>/opt/tomcat/bin/startup.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">ExecStop&lt;/span>&lt;span class="o">=&lt;/span>/opt/tomcat/bin/shutdown.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">RestartSec&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">Restart&lt;/span>&lt;span class="o">=&lt;/span>always
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Install&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">WantedBy&lt;/span>&lt;span class="o">=&lt;/span>multi-user.target
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 生成目标页面&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:~ &lt;span class="c1"># cd /opt/tomcat/webapps/ROOT&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat/webapps/ROOT# vim index.html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tomcat hello !!!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 启动服务&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat# sudo systemctl daemon-reload
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat# sudo systemctl start tomcat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat# sudo systemctl status tomcat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">● tomcat.service - Apache Tomcat Web Application Container
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Loaded: loaded &lt;span class="o">(&lt;/span>/etc/systemd/system/tomcat.service&lt;span class="p">;&lt;/span> disabled&lt;span class="p">;&lt;/span> preset: enabled&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Active: active &lt;span class="o">(&lt;/span>running&lt;span class="o">)&lt;/span> since Mon 2025-05-19 09:36:27 EDT&lt;span class="p">;&lt;/span> 5s ago
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Process: &lt;span class="m">2271&lt;/span> &lt;span class="nv">ExecStart&lt;/span>&lt;span class="o">=&lt;/span>/opt/tomcat/bin/startup.sh &lt;span class="o">(&lt;/span>&lt;span class="nv">code&lt;/span>&lt;span class="o">=&lt;/span>exited, &lt;span class="nv">status&lt;/span>&lt;span class="o">=&lt;/span>0/SUCCESS&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Main PID: &lt;span class="m">2278&lt;/span> &lt;span class="o">(&lt;/span>java&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Tasks: &lt;span class="m">38&lt;/span> &lt;span class="o">(&lt;/span>limit: 2241&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Memory: 80.5M
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CPU: 2.304s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CGroup: /system.slice/tomcat.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> └─2278 /usr/lib/jvm/java-17-openjdk-amd64/bin/java -Djava.util.logging.config.file&lt;span class="o">=&lt;/span>/opt/tomcat/conf/logging.properties -Djava.util.logging.m&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">May &lt;span class="m">19&lt;/span> 09:36:27 debian systemd&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span>: Starting tomcat.service - Apache Tomcat Web Application Container...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">May &lt;span class="m">19&lt;/span> 09:36:27 debian startup.sh&lt;span class="o">[&lt;/span>2271&lt;span class="o">]&lt;/span>: Tomcat started.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">May &lt;span class="m">19&lt;/span> 09:36:27 debian systemd&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span>: Started tomcat.service - Apache Tomcat Web Application Container.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 本地验证&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat/webapps/ROOT# curl localhost:8080/index.html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tomcat hello !!!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="操作步骤2nginx配置">操作步骤2：nginx配置
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 配置nginx代理地址:端口&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat/webapps/ROOT# &lt;span class="nb">cd&lt;/span> /etc/nginx/conf.d/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/etc/nginx/conf.d# vim default.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> location / &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># root /usr/share/nginx/html;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># index index.html index.htm;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_pass http://127.0.0.1:8080&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 重新加载nginx配置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/etc/nginx/conf.d# /usr/sbin/nginx -s reload
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="操作步骤3本地验证">操作步骤3：本地验证
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">C:&lt;span class="se">\U&lt;/span>sers&lt;span class="se">\Y&lt;/span>Y&amp;gt;curl http://127.0.0.1:3000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tomcat hello !!!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;img src="https://caijemmy.github.io/p/1.0-nginx/image-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%AA%8C%E8%AF%811.png"
width="698"
height="289"
srcset="https://caijemmy.github.io/p/1.0-nginx/image-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%AA%8C%E8%AF%811_hu_b1ad05c57644e02.png 480w, https://caijemmy.github.io/p/1.0-nginx/image-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%AA%8C%E8%AF%811_hu_71c80484568c822e.png 1024w"
loading="lazy"
alt="image-反向代理验证1"
class="gallery-image"
data-flex-grow="241"
data-flex-basis="579px"
>&lt;/p>
&lt;h3 id="多台代理">多台代理
&lt;/h3>&lt;h4 id="目标-1">目标
&lt;/h4>&lt;ul>
&lt;li>浏览器访问：（http://127.0.0.1:3000/beijing），通过nginx，跳转到一个tomcat上 （http://localhost:8081），在浏览器上显示：beijing。&lt;/li>
&lt;li>浏览器访问：（http://127.0.0.1:3000/shanghai），通过nginx，跳转到一个tomcat上（http://localhost:8082），在浏览器上显示：shanghai&lt;/li>
&lt;/ul>
&lt;h4 id="操作步骤1安装tomcat-1">操作步骤1：安装tomcat
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 在单台代理的基础上，拷贝两个tomcat，再配置两个tomcat&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat8081/conf# vim server.xml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;Server &lt;span class="nv">port&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;8015&amp;#34;&lt;/span> &lt;span class="nv">shutdown&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;SHUTDOWN&amp;#34;&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;Connector &lt;span class="nv">port&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;8081&amp;#34;&lt;/span> &lt;span class="nv">protocol&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;HTTP/1.1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">connectionTimeout&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;20000&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">redirectPort&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;8443&amp;#34;&lt;/span> /&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat8082/conf# vim server.xml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;Server &lt;span class="nv">port&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;8025&amp;#34;&lt;/span> &lt;span class="nv">shutdown&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;SHUTDOWN&amp;#34;&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;Connector &lt;span class="nv">port&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;8082&amp;#34;&lt;/span> &lt;span class="nv">protocol&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;HTTP/1.1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">connectionTimeout&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;20000&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">redirectPort&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;8453&amp;#34;&lt;/span> /&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 停止tomcat&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat8082/conf# systemctl stop tomcat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat8082/conf# systemctl status tomcat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">○ tomcat.service - Apache Tomcat Web Application Container
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Loaded: loaded &lt;span class="o">(&lt;/span>/etc/systemd/system/tomcat.service&lt;span class="p">;&lt;/span> disabled&lt;span class="p">;&lt;/span> preset: enabled&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Active: inactive &lt;span class="o">(&lt;/span>dead&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 修改html文件内容&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat8081/webapps/beijing &lt;span class="c1"># vim index.html&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">beijing
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat8082/webapps/shanghai &lt;span class="c1"># vim index.html&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">shanghai
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 启动服务并验证&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">CATALINA_HOME&lt;/span>&lt;span class="o">=&lt;/span>/opt/tomcat8081
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">PATH&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$CATALINA_HOME&lt;/span>/bin:&lt;span class="nv">$PATH&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat8081# ./bin/startup.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat8081# curl http://localhost:8081
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">beijing
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">CATALINA_HOME&lt;/span>&lt;span class="o">=&lt;/span>/opt/tomcat8082
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">PATH&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$CATALINA_HOME&lt;/span>/bin:&lt;span class="nv">$PATH&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat8082# ./bin/startup.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat8082# curl http://localhost:8082
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">shanghai
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="操作步骤2nginx配置-1">操作步骤2：nginx配置
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 配置nginx代理地址:端口&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat/webapps/ROOT# &lt;span class="nb">cd&lt;/span> /etc/nginx/conf.d/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/etc/nginx/conf.d# vim default.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> location ~ /beijing/ &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_pass http://127.0.0.1:8081&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> location ~ /shanghai/ &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_pass http://127.0.0.1:8082&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> location / &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># root /usr/share/nginx/html;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># index index.html index.htm;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_pass http://127.0.0.1:8080&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 重新加载nginx配置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/etc/nginx/conf.d# /usr/sbin/nginx -s reload
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="操作步骤3本地验证-1">操作步骤3：本地验证
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">C:&lt;span class="se">\U&lt;/span>sers&lt;span class="se">\Y&lt;/span>Y&amp;gt;curl http://127.0.0.1:3000/shanghai/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">shanghai
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">C:&lt;span class="se">\U&lt;/span>sers&lt;span class="se">\Y&lt;/span>Y&amp;gt;curl http://127.0.0.1:3000/shanghai/index.html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">shanghai
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">C:&lt;span class="se">\U&lt;/span>sers&lt;span class="se">\Y&lt;/span>Y&amp;gt;curl http://127.0.0.1:3000/beijing/index.html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">beijing
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">C:&lt;span class="se">\U&lt;/span>sers&lt;span class="se">\Y&lt;/span>Y&amp;gt;curl http://127.0.0.1:3000/beijing/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">beijing
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;img src="https://caijemmy.github.io/p/1.0-nginx/image-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%AA%8C%E8%AF%81%E5%A4%9A%E5%8F%B01.png"
width="701"
height="158"
srcset="https://caijemmy.github.io/p/1.0-nginx/image-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%AA%8C%E8%AF%81%E5%A4%9A%E5%8F%B01_hu_2aeff50651581a00.png 480w, https://caijemmy.github.io/p/1.0-nginx/image-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%AA%8C%E8%AF%81%E5%A4%9A%E5%8F%B01_hu_85bec14e5a55d61.png 1024w"
loading="lazy"
alt="image-反向代理验证多台1"
class="gallery-image"
data-flex-grow="443"
data-flex-basis="1064px"
>&lt;/p>
&lt;p>&lt;img src="https://caijemmy.github.io/p/1.0-nginx/image-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%AA%8C%E8%AF%81%E5%A4%9A%E5%8F%B02.png"
width="784"
height="170"
srcset="https://caijemmy.github.io/p/1.0-nginx/image-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%AA%8C%E8%AF%81%E5%A4%9A%E5%8F%B02_hu_2583ff73fbb9165a.png 480w, https://caijemmy.github.io/p/1.0-nginx/image-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%AA%8C%E8%AF%81%E5%A4%9A%E5%8F%B02_hu_1f3a8ffdab141b91.png 1024w"
loading="lazy"
alt="image-反向代理验证多台2"
class="gallery-image"
data-flex-grow="461"
data-flex-basis="1106px"
>&lt;/p>
&lt;p>&lt;img src="https://caijemmy.github.io/p/1.0-nginx/image-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%AA%8C%E8%AF%81%E5%A4%9A%E5%8F%B03.png"
width="659"
height="152"
srcset="https://caijemmy.github.io/p/1.0-nginx/image-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%AA%8C%E8%AF%81%E5%A4%9A%E5%8F%B03_hu_496c4dc84b1c6863.png 480w, https://caijemmy.github.io/p/1.0-nginx/image-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%AA%8C%E8%AF%81%E5%A4%9A%E5%8F%B03_hu_5a4597dc6b12f832.png 1024w"
loading="lazy"
alt="image-反向代理验证多台3"
class="gallery-image"
data-flex-grow="433"
data-flex-basis="1040px"
>&lt;/p>
&lt;p>&lt;img src="https://caijemmy.github.io/p/1.0-nginx/image-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%AA%8C%E8%AF%81%E5%A4%9A%E5%8F%B04.png"
width="798"
height="153"
srcset="https://caijemmy.github.io/p/1.0-nginx/image-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%AA%8C%E8%AF%81%E5%A4%9A%E5%8F%B04_hu_1b2d73a83bc8d029.png 480w, https://caijemmy.github.io/p/1.0-nginx/image-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%AA%8C%E8%AF%81%E5%A4%9A%E5%8F%B04_hu_b7817ab95575409c.png 1024w"
loading="lazy"
alt="image-反向代理验证多台4"
class="gallery-image"
data-flex-grow="521"
data-flex-basis="1251px"
>&lt;/p>
&lt;h2 id="负载均衡">负载均衡
&lt;/h2>&lt;h3 id="目标-2">目标
&lt;/h3>&lt;ul>
&lt;li>通过浏览器多次访问一个地址（http://www.cainiao.com/load-balance）。&lt;/li>
&lt;li>nginx接受上面的请求，并进行转发。&lt;/li>
&lt;li>那么每个请求的响应，是来自于不同的tomcat提供的。（2台tomcat，端口：8081，8082）。 两台tomcat，不同的响应内容：“8081”和“8082”。&lt;/li>
&lt;/ul>
&lt;h3 id="操作步骤">操作步骤
&lt;/h3>&lt;h4 id="部署tomcat">部署tomcat
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 还是使用多台代理时的tomcat&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:~# &lt;span class="nb">cd&lt;/span> /opt/tomcat8081/webapps
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat8081/webapps# mkdir load-balance
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat8081/webapps# vim load-balance/index.html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">8081&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:~# &lt;span class="nb">cd&lt;/span> /opt/tomcat8082/webapps
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat8082/webapps# mkdir load-balance
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat8082/webapps# vim load-balance/index.html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">8082&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 启动服务&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">CATALINA_HOME&lt;/span>&lt;span class="o">=&lt;/span>/opt/tomcat8081
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">PATH&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$CATALINA_HOME&lt;/span>/bin:&lt;span class="nv">$PATH&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat8081# /opt/tomcat8081/bin/startup.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">CATALINA_HOME&lt;/span>&lt;span class="o">=&lt;/span>/opt/tomcat8082
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">PATH&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$CATALINA_HOME&lt;/span>/bin:&lt;span class="nv">$PATH&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat8082# /opt/tomcat8082/bin/startup.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat8082# curl http://127.0.0.1/load-balance/index.html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">8081&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat8082# curl http://127.0.0.1/load-balance/index.html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">8082&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="配置nginx">配置nginx
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">root@debian:/opt/tomcat8082# cat /etc/nginx/conf.d/default.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># upstream 要配置在http块中&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">upstream myServers &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server 127.0.0.1:8081&lt;span class="p">;&lt;/span> &lt;span class="c1"># server 指令只能指定 IP 地址（或域名）和端口&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server 127.0.0.1:8082&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">server &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> listen 80&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server_name localhost&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> location / &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># root /usr/share/nginx/html;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># index index.html index.htm;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_pass http://myServers&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">......
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 重新加载服务配置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/etc/nginx/conf.d# /usr/sbin/nginx -s reload
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>注意&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>upstream 要配置在http块中&lt;/li>
&lt;li>upstream 的server 指令只能指定 IP 地址（或域名）和端口&lt;/li>
&lt;/ul>
&lt;h4 id="验证">验证
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">C:&lt;span class="se">\U&lt;/span>sers&lt;span class="se">\Y&lt;/span>Y&amp;gt;curl http://127.0.0.1:3000/load-balance/index.html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">8081&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">C:&lt;span class="se">\U&lt;/span>sers&lt;span class="se">\Y&lt;/span>Y&amp;gt;curl http://127.0.0.1:3000/load-balance/index.html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">8082&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;img src="https://caijemmy.github.io/p/1.0-nginx/image-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%AA%8C%E8%AF%811.png"
width="851"
height="156"
srcset="https://caijemmy.github.io/p/1.0-nginx/image-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%AA%8C%E8%AF%811_hu_e88eccb4f1276ab.png 480w, https://caijemmy.github.io/p/1.0-nginx/image-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%AA%8C%E8%AF%811_hu_20f21a5154f24930.png 1024w"
loading="lazy"
alt="image-负载均衡验证1"
class="gallery-image"
data-flex-grow="545"
data-flex-basis="1309px"
>&lt;/p>
&lt;p>&lt;img src="https://caijemmy.github.io/p/1.0-nginx/image-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%AA%8C%E8%AF%812.png"
width="874"
height="141"
srcset="https://caijemmy.github.io/p/1.0-nginx/image-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%AA%8C%E8%AF%812_hu_d1d840b9ae3405db.png 480w, https://caijemmy.github.io/p/1.0-nginx/image-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%AA%8C%E8%AF%812_hu_69ce617b94182124.png 1024w"
loading="lazy"
alt="image-负载均衡验证2"
class="gallery-image"
data-flex-grow="619"
data-flex-basis="1487px"
>&lt;/p>
&lt;h3 id="负载均衡的方法算法">负载均衡的方法（算法）
&lt;/h3>&lt;p>参考链接：https://docs.nginx.com/nginx/admin-guide/load-balancer/http-load-balancer/&lt;/p>
&lt;h4 id="round-robin">Round Robin
&lt;/h4>&lt;p>Requests are distributed evenly across the servers, with &lt;a class="link" href="https://docs.nginx.com/nginx/admin-guide/load-balancer/http-load-balancer/#weights" target="_blank" rel="noopener"
>server weights&lt;/a> taken into consideration. This method is used by default (there is no directive for enabling it)&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">upstream backend &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># no load balancing method is specified for Round Robin&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server backend1.example.com&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server backend2.example.com&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="least-connections">Least Connections
&lt;/h4>&lt;p>A request is sent to the server with the least number of active connections, again with &lt;a class="link" href="https://docs.nginx.com/nginx/admin-guide/load-balancer/http-load-balancer/#weights" target="_blank" rel="noopener"
>server weights&lt;/a> taken into consideration&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">upstream backend &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> least_conn&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server backend1.example.com&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server backend2.example.com&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="ip-hash">IP Hash
&lt;/h4>&lt;p>The server to which a request is sent is determined from the client IP address. In this case, either the first three octets of the IPv4 address or the whole IPv6 address are used to calculate the hash value. The method guarantees that requests from the same address get to the same server unless it is not available.&lt;/p>
&lt;p>通过这种方式，客户端的请求会转发到同一台服务器上&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">upstream backend &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip_hash&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server backend1.example.com&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server backend2.example.com&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server backend3.example.com down&lt;span class="p">;&lt;/span> &lt;span class="c1"># 如果一台服务器不能整体提供服务，自动转发到下一台服务器&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="generic-hash">Generic Hash
&lt;/h4>&lt;p>The server to which a request is sent is determined from a user‑defined key which can be a text string, variable, or a combination. For example, the key may be a paired source IP address and port, or a URI as in this example:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">upstream backend &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">hash&lt;/span> &lt;span class="nv">$request_uri&lt;/span> consistent&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server backend1.example.com&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server backend2.example.com&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="least-time-nginx-plus-only">Least Time (NGINX Plus only)
&lt;/h4>&lt;p>For each request, NGINX Plus selects the server with the lowest average latency and the lowest number of active connections, where the lowest average latency is calculated based on which of the following parameters to the least_time directive is included:&lt;/p>
&lt;p>&lt;strong>暂不涉及，使用时再查看文档&lt;/strong>&lt;/p>
&lt;h4 id="random">Random
&lt;/h4>&lt;p>Each request will be passed to a randomly selected server. If the two parameter is specified, first, NGINX randomly selects two servers taking into account server weights, and then chooses one of these servers using the specified method:&lt;/p>
&lt;ul>
&lt;li>least_conn – The least number of active connections&lt;/li>
&lt;li>least_time=header (NGINX Plus) – The least average time to receive the response header from the server ($upstream_header_time)&lt;/li>
&lt;li>least_time=last_byte (NGINX Plus) – The least average time to receive the full response from the server ($upstream_response_time)&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">upstream backend &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> random two &lt;span class="nv">least_time&lt;/span>&lt;span class="o">=&lt;/span>last_byte&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server backend1.example.com&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server backend2.example.com&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server backend3.example.com&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server backend4.example.com&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="server-weights权重">Server Weights(权重)
&lt;/h3>&lt;p>By default, NGINX distributes requests among the servers in the group according to their weights using the Round Robin method. The &lt;a class="link" href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html#weight" target="_blank" rel="noopener"
>&lt;code>weight&lt;/code>&lt;/a> parameter to the &lt;a class="link" href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html#server" target="_blank" rel="noopener"
>&lt;code>server&lt;/code>&lt;/a> directive sets the weight of a server; the default is &lt;code>1&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">upstream backend &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server backend1.example.com &lt;span class="nv">weight&lt;/span>&lt;span class="o">=&lt;/span>5&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server backend2.example.com&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server 192.0.0.1 backup&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># With this configuration of weights, out of every 6 requests, 5 are sent to backend1.example.com and 1 to backend2.example.com.&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="动静分离">动静分离
&lt;/h2>&lt;h3 id="什么是-nginx-的动静分离">什么是 Nginx 的动静分离？
&lt;/h3>&lt;p>动静分离是指将 &lt;strong>静态资源（如 HTML、CSS、JavaScript、图片等）&lt;/strong> 和 &lt;strong>动态资源（如 PHP、Java、Python 等生成的动态内容）&lt;/strong> 分别处理，以提高服务器性能和资源利用率。&lt;/p>
&lt;ul>
&lt;li>&lt;strong>静态资源&lt;/strong>：内容固定不变，可以直接从磁盘或缓存中读取，不需要经过后端应用服务器处理。&lt;/li>
&lt;li>&lt;strong>动态资源&lt;/strong>：内容根据请求动态生成，需要经过后端应用服务器（如 Tomcat、PHP-FPM 等）处理。&lt;/li>
&lt;/ul>
&lt;p>通过动静分离，可以将静态资源交给 Nginx 直接处理，而动态资源则转发给后端应用服务器处理，从而减轻后端服务器的压力，并提高静态资源的访问速度。&lt;/p>
&lt;h3 id="为什么要做动静分离">为什么要做动静分离？
&lt;/h3>&lt;ol>
&lt;li>&lt;strong>提高性能&lt;/strong>：Nginx 处理静态资源的性能非常高，远高于后端应用服务器。&lt;/li>
&lt;li>&lt;strong>减轻后端压力&lt;/strong>：将静态资源交给 Nginx 处理，减少后端服务器的负载。&lt;/li>
&lt;li>&lt;strong>提高用户体验&lt;/strong>：静态资源加载更快，提升页面响应速度。&lt;/li>
&lt;li>&lt;strong>便于扩展&lt;/strong>：静态资源可以单独部署到 CDN 或专门的静态资源服务器上。&lt;/li>
&lt;/ol>
&lt;h3 id="如何实现-nginx-的动静分离">如何实现 Nginx 的动静分离？
&lt;/h3>&lt;h4 id="静态资源和动态资源的分类">静态资源和动态资源的分类
&lt;/h4>&lt;ul>
&lt;li>静态资源：&lt;code>.html&lt;/code>, &lt;code>.css&lt;/code>, &lt;code>.js&lt;/code>, &lt;code>.jpg&lt;/code>, &lt;code>.png&lt;/code>, &lt;code>.gif&lt;/code>, &lt;code>.ico&lt;/code>, &lt;code>.woff&lt;/code>, &lt;code>.ttf&lt;/code> 等。&lt;/li>
&lt;li>动态资源：&lt;code>.php&lt;/code>, &lt;code>.jsp&lt;/code>, &lt;code>.do&lt;/code>, &lt;code>.py&lt;/code> 等。&lt;/li>
&lt;/ul>
&lt;h4 id="nginx-配置动静分离">Nginx 配置动静分离
&lt;/h4>&lt;p>通过 &lt;code>location&lt;/code> 块将静态资源和动态资源分别处理。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">server &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> listen 8000&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server_name cainiao.com&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 静态资源处理&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> location ~* &lt;span class="se">\.&lt;/span>&lt;span class="o">(&lt;/span>html&lt;span class="p">|&lt;/span>css&lt;span class="p">|&lt;/span>js&lt;span class="p">|&lt;/span>jpg&lt;span class="p">|&lt;/span>jpeg&lt;span class="p">|&lt;/span>png&lt;span class="p">|&lt;/span>gif&lt;span class="p">|&lt;/span>ico&lt;span class="p">|&lt;/span>woff&lt;span class="p">|&lt;/span>ttf&lt;span class="o">)&lt;/span>$ &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> root /var/www/static&lt;span class="p">;&lt;/span> &lt;span class="c1"># 静态资源存放目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> expires 30d&lt;span class="p">;&lt;/span> &lt;span class="c1"># 设置缓存过期时间&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 动态资源处理&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> location / &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_pass http://backend_server&lt;span class="p">;&lt;/span> &lt;span class="c1"># 转发到后端应用服务器&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_set_header Host &lt;span class="nv">$host&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_set_header X-Real-IP &lt;span class="nv">$remote_addr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_set_header X-Forwarded-For &lt;span class="nv">$proxy_add_x_forwarded_for&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">upstream backend_server &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server 127.0.0.1:8080&lt;span class="p">;&lt;/span> &lt;span class="c1"># 后端应用服务器地址&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="配置说明">配置说明
&lt;/h4>&lt;ol>
&lt;li>&lt;strong>静态资源处理&lt;/strong>：
&lt;ul>
&lt;li>使用 &lt;code>location ~* \.(html|css|js|jpg|jpeg|png|gif|ico|woff|ttf)$&lt;/code> 匹配静态资源文件。&lt;/li>
&lt;li>&lt;code>root /var/www/static&lt;/code>：指定静态资源的存放目录。&lt;/li>
&lt;li>&lt;code>expires 30d&lt;/code>：设置静态资源的缓存过期时间，减少客户端请求。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>动态资源处理&lt;/strong>：
&lt;ul>
&lt;li>使用 &lt;code>location /&lt;/code> 匹配所有请求。&lt;/li>
&lt;li>&lt;code>proxy_pass http://backend_server&lt;/code>：将动态资源请求转发到后端应用服务器。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>后端服务器&lt;/strong>：
&lt;ul>
&lt;li>使用 &lt;code>upstream&lt;/code> 定义后端应用服务器组。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h4 id="测试动静分离">测试动静分离
&lt;/h4>&lt;p>&lt;strong>配置修改步骤&lt;/strong>：&lt;/p>
&lt;p>1、域名映射&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">C:&lt;span class="se">\W&lt;/span>indows&lt;span class="se">\S&lt;/span>ystem32&lt;span class="se">\d&lt;/span>rivers&lt;span class="se">\e&lt;/span>tc&lt;span class="se">\h&lt;/span>osts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">127.0.0.1 cainiao.com
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>2、配置nginx&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">root@debian:/etc/nginx# vim nginx.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 在http模块的最后添加如下内容&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> listen 8000&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server_name cainiao.com&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 静态资源处理&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> location ~* &lt;span class="se">\.&lt;/span>&lt;span class="o">(&lt;/span>html&lt;span class="p">|&lt;/span>css&lt;span class="p">|&lt;/span>js&lt;span class="p">|&lt;/span>jpg&lt;span class="p">|&lt;/span>jpeg&lt;span class="p">|&lt;/span>png&lt;span class="p">|&lt;/span>gif&lt;span class="p">|&lt;/span>ico&lt;span class="p">|&lt;/span>woff&lt;span class="p">|&lt;/span>ttf&lt;span class="o">)&lt;/span>$ &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> root /var/www/static&lt;span class="p">;&lt;/span> &lt;span class="c1"># 静态资源存放目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> expires 30d&lt;span class="p">;&lt;/span> &lt;span class="c1"># 设置缓存过期时间&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 动态资源处理&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> location / &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_pass http://backend_server&lt;span class="p">;&lt;/span> &lt;span class="c1"># 转发到后端应用服务器&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_set_header Host &lt;span class="nv">$host&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_set_header X-Real-IP &lt;span class="nv">$remote_addr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> proxy_set_header X-Forwarded-For &lt;span class="nv">$proxy_add_x_forwarded_for&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> upstream backend_server &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> server 127.0.0.1:8080&lt;span class="p">;&lt;/span> &lt;span class="c1"># 后端应用服务器地址&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 重新加载服务配置&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/etc/nginx/conf.d# /usr/sbin/nginx -s reload
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>3、配置资源&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">root@debian:/etc/nginx# mkdir -p /var/www/static
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 上传一个名为logo.png的图片到该目录下&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>4、主机配置端口映射&lt;/p>
&lt;p>&lt;img src="https://caijemmy.github.io/p/1.0-nginx/image-%E4%B8%BB%E6%9C%BA%E9%85%8D%E7%BD%AE%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84%E5%88%B0%E6%9C%8D%E5%8A%A1%E5%99%A88000%E7%AB%AF%E5%8F%A3.png"
width="888"
height="583"
srcset="https://caijemmy.github.io/p/1.0-nginx/image-%E4%B8%BB%E6%9C%BA%E9%85%8D%E7%BD%AE%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84%E5%88%B0%E6%9C%8D%E5%8A%A1%E5%99%A88000%E7%AB%AF%E5%8F%A3_hu_38038ea2f1c224c7.png 480w, https://caijemmy.github.io/p/1.0-nginx/image-%E4%B8%BB%E6%9C%BA%E9%85%8D%E7%BD%AE%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84%E5%88%B0%E6%9C%8D%E5%8A%A1%E5%99%A88000%E7%AB%AF%E5%8F%A3_hu_236a80a9eba6e487.png 1024w"
loading="lazy"
alt="image-主机配置端口映射到服务器8000端口"
class="gallery-image"
data-flex-grow="152"
data-flex-basis="365px"
>&lt;/p>
&lt;p>5、浏览器验证静态资源&lt;/p>
&lt;p>&lt;img src="https://caijemmy.github.io/p/1.0-nginx/image-%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E6%AD%A3%E5%B8%B8%E8%BF%94%E5%9B%9E.png"
width="1964"
height="1612"
srcset="https://caijemmy.github.io/p/1.0-nginx/image-%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E6%AD%A3%E5%B8%B8%E8%BF%94%E5%9B%9E_hu_d805c8f593a5b5e3.png 480w, https://caijemmy.github.io/p/1.0-nginx/image-%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E6%AD%A3%E5%B8%B8%E8%BF%94%E5%9B%9E_hu_410b0165db76e75b.png 1024w"
loading="lazy"
alt="image-静态资源正常返回"
class="gallery-image"
data-flex-grow="121"
data-flex-basis="292px"
>&lt;/p>
&lt;p>6、浏览器验证动态资源&lt;/p>
&lt;p>&lt;img src="https://caijemmy.github.io/p/1.0-nginx/image-%E5%8A%A8%E6%80%81%E8%B5%84%E6%BA%90%E6%AD%A3%E5%B8%B8%E8%BF%94%E5%9B%9E.png"
width="1784"
height="811"
srcset="https://caijemmy.github.io/p/1.0-nginx/image-%E5%8A%A8%E6%80%81%E8%B5%84%E6%BA%90%E6%AD%A3%E5%B8%B8%E8%BF%94%E5%9B%9E_hu_5d2b6ab120673d96.png 480w, https://caijemmy.github.io/p/1.0-nginx/image-%E5%8A%A8%E6%80%81%E8%B5%84%E6%BA%90%E6%AD%A3%E5%B8%B8%E8%BF%94%E5%9B%9E_hu_c3c9f3452c817e67.png 1024w"
loading="lazy"
alt="image-动态资源正常返回"
class="gallery-image"
data-flex-grow="219"
data-flex-basis="527px"
>&lt;/p>
&lt;h3 id="进一步优化">进一步优化
&lt;/h3>&lt;ol>
&lt;li>
&lt;p>&lt;strong>使用 CDN&lt;/strong>： 将静态资源部署到 CDN（内容分发网络），进一步提高静态资源的访问速度。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>启用 Gzip 压缩&lt;/strong>： 在 Nginx 中启用 Gzip 压缩，减少静态资源的传输大小。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">gzip on&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;strong>设置缓存策略&lt;/strong>： 为静态资源设置合理的缓存策略，减少客户端请求。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">location ~* &lt;span class="se">\.&lt;/span>&lt;span class="o">(&lt;/span>html&lt;span class="p">|&lt;/span>css&lt;span class="p">|&lt;/span>js&lt;span class="p">|&lt;/span>jpg&lt;span class="p">|&lt;/span>jpeg&lt;span class="p">|&lt;/span>png&lt;span class="p">|&lt;/span>gif&lt;span class="p">|&lt;/span>ico&lt;span class="p">|&lt;/span>woff&lt;span class="p">|&lt;/span>ttf&lt;span class="o">)&lt;/span>$ &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> root /var/www/static&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> expires 30d&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> add_header Cache-Control &lt;span class="s2">&amp;#34;public, no-transform&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="高可用">高可用
&lt;/h2>&lt;h3 id="架构图">架构图
&lt;/h3>&lt;p>&lt;img src="https://caijemmy.github.io/p/1.0-nginx/image-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84%E5%9B%BE.png"
width="1304"
height="805"
srcset="https://caijemmy.github.io/p/1.0-nginx/image-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84%E5%9B%BE_hu_14f65318d7d8c3f3.png 480w, https://caijemmy.github.io/p/1.0-nginx/image-%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84%E5%9B%BE_hu_6b65b6a924b2ca90.png 1024w"
loading="lazy"
alt="image-高可用架构图"
class="gallery-image"
data-flex-grow="161"
data-flex-basis="388px"
>&lt;/p>
&lt;h3 id="环境准备">环境准备
&lt;/h3>&lt;h4 id="前提条件">前提条件
&lt;/h4>&lt;p>拷贝复制前面nginx虚机，修改虚机IP为192.168.52.70&lt;/p>
&lt;h4 id="安装keepalived">安装keepalived
&lt;/h4>&lt;p>&lt;strong>每个虚机都安装&lt;/strong>，详细可以参考：&lt;a class="link" href="https://caijemmy.github.io/p/1.0-keepalived/" target="_blank" rel="noopener"
>keepalived入门介绍&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">apt -y install keepalived
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 主节点&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/etc/keepalived# vim keepalived.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! Configuration File &lt;span class="k">for&lt;/span> keepalived
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">global_defs &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vrrp_instance VI_1 &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> state MASTER
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> interface ens33
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> virtual_router_id &lt;span class="m">51&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> priority &lt;span class="m">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> advert_int &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> authentication &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> auth_type PASS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> auth_pass &lt;span class="m">1111&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> virtual_ipaddress &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 192.168.52.99
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 备节点&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/etc/keepalived# cat keepalived.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">! Configuration File &lt;span class="k">for&lt;/span> keepalived
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">global_defs &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">vrrp_instance VI_1 &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> state BACKUP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> interface ens33
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> virtual_router_id &lt;span class="m">51&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> priority &lt;span class="m">80&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> advert_int &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> authentication &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> auth_type PASS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> auth_pass &lt;span class="m">1111&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> virtual_ipaddress &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 192.168.52.99
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 启动服务&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/etc/keepalived# systemctl start keepalived.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/etc/keepalived# systemctl status keepalived.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">● keepalived.service - Keepalive Daemon &lt;span class="o">(&lt;/span>LVS and VRRP&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Loaded: loaded &lt;span class="o">(&lt;/span>/lib/systemd/system/keepalived.service&lt;span class="p">;&lt;/span> enabled&lt;span class="p">;&lt;/span> preset: enabled&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Active: active &lt;span class="o">(&lt;/span>running&lt;span class="o">)&lt;/span> since Tue 2025-05-20 22:14:30 EDT&lt;span class="p">;&lt;/span> 1s ago
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Docs: man:keepalived&lt;span class="o">(&lt;/span>8&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> man:keepalived.conf&lt;span class="o">(&lt;/span>5&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> man:genhash&lt;span class="o">(&lt;/span>1&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> https://keepalived.org
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Main PID: &lt;span class="m">1681&lt;/span> &lt;span class="o">(&lt;/span>keepalived&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Tasks: &lt;span class="m">2&lt;/span> &lt;span class="o">(&lt;/span>limit: 2241&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Memory: 3.7M
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CPU: 17ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> CGroup: /system.slice/keepalived.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ├─1681 /usr/sbin/keepalived --dont-fork
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> └─1682 /usr/sbin/keepalived --dont-fork
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="验证-1">验证
&lt;/h3>&lt;p>&lt;img src="https://caijemmy.github.io/p/1.0-nginx/image-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%AA%8C%E8%AF%811.png"
width="1915"
height="524"
srcset="https://caijemmy.github.io/p/1.0-nginx/image-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%AA%8C%E8%AF%811_hu_69a6eaec32084434.png 480w, https://caijemmy.github.io/p/1.0-nginx/image-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%AA%8C%E8%AF%811_hu_2ea8cf5f198d34a6.png 1024w"
loading="lazy"
alt="image-高可用验证"
class="gallery-image"
data-flex-grow="365"
data-flex-basis="877px"
>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 停止主节点192.168.52.60上的keepalived服务&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:~# ip a s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu &lt;span class="m">65536&lt;/span> qdisc noqueue state UNKNOWN group default qlen &lt;span class="m">1000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> inet 127.0.0.1/8 scope host lo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> valid_lft forever preferred_lft forever
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> inet6 ::1/128 scope host noprefixroute
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> valid_lft forever preferred_lft forever
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2: ens33: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu &lt;span class="m">1500&lt;/span> qdisc fq_codel state UP group default qlen &lt;span class="m">1000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> link/ether 00:0c:29:dc:2d:71 brd ff:ff:ff:ff:ff:ff
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> altname enp2s1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> inet 192.168.52.60/24 brd 192.168.52.255 scope global noprefixroute ens33
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> valid_lft forever preferred_lft forever
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> inet 192.168.52.99/32 scope global ens33
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> valid_lft forever preferred_lft forever
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> inet6 fe80::20c:29ff:fedc:2d71/64 scope link noprefixroute
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> valid_lft forever preferred_lft forever
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:~# systemctl stop keepalived.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:~# ip a s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu &lt;span class="m">65536&lt;/span> qdisc noqueue state UNKNOWN group default qlen &lt;span class="m">1000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> inet 127.0.0.1/8 scope host lo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> valid_lft forever preferred_lft forever
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> inet6 ::1/128 scope host noprefixroute
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> valid_lft forever preferred_lft forever
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2: ens33: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu &lt;span class="m">1500&lt;/span> qdisc fq_codel state UP group default qlen &lt;span class="m">1000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> link/ether 00:0c:29:dc:2d:71 brd ff:ff:ff:ff:ff:ff
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> altname enp2s1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> inet 192.168.52.60/24 brd 192.168.52.255 scope global noprefixroute ens33
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> valid_lft forever preferred_lft forever
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> inet6 fe80::20c:29ff:fedc:2d71/64 scope link noprefixroute
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> valid_lft forever preferred_lft forever
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>再次通过浏览器访问&lt;/p>
&lt;p>&lt;img src="https://caijemmy.github.io/p/1.0-nginx/image-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%AA%8C%E8%AF%812.png"
width="1915"
height="524"
srcset="https://caijemmy.github.io/p/1.0-nginx/image-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%AA%8C%E8%AF%812_hu_69a6eaec32084434.png 480w, https://caijemmy.github.io/p/1.0-nginx/image-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%AA%8C%E8%AF%812_hu_2ea8cf5f198d34a6.png 1024w"
loading="lazy"
alt="image-高可用验证"
class="gallery-image"
data-flex-grow="365"
data-flex-basis="877px"
>&lt;/p></description></item><item><title>2.0 nginx</title><link>https://caijemmy.github.io/p/2.0-nginx/</link><pubDate>Wed, 24 Jul 2024 00:00:00 +0000</pubDate><guid>https://caijemmy.github.io/p/2.0-nginx/</guid><description>&lt;img src="https://caijemmy.github.io/p/2.0-nginx/cover.jpg" alt="Featured image of post 2.0 nginx" />&lt;h2 id="servername的多种匹配方式">servername的多种匹配方式
&lt;/h2>&lt;h3 id="同一端口配置不同域名">同一端口配置不同域名
&lt;/h3>&lt;h4 id="提前准备">提前准备
&lt;/h4>&lt;p>本地主机配置hosts文件&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">C:&lt;span class="se">\W&lt;/span>indows&lt;span class="se">\S&lt;/span>ystem32&lt;span class="se">\d&lt;/span>rivers&lt;span class="se">\e&lt;/span>tc&lt;span class="se">\h&lt;/span>osts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># nginx验证同一端口配置不同域名&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.52.60 cainiao1.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.52.60 cainiao2.com
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>虚拟主机做以下配置&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">root@debian:/var/www# mkdir cainiao1 cainiao2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/var/www# &lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;this is &amp;lt;br&amp;gt; cainiao1&amp;#39;&lt;/span> &amp;gt; cainiao1/index.html
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@debian:/var/www# &lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;this is &amp;lt;br&amp;gt; cainiao2&amp;#39;&lt;/span> &amp;gt; cainiao2/index.html
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="配置nginx">配置nginx
&lt;/h4>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 将以下内容防止配置文件http模块最后
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">root@debian:~&lt;/span>&lt;span class="c1"># vim /etc/nginx/nginx.conf
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="s">server&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">listen&lt;/span> &lt;span class="mi">80&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server_name&lt;/span> &lt;span class="s">cainiao1.com&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">location&lt;/span> &lt;span class="s">/&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">root&lt;/span> &lt;span class="s">/var/www/cainiao1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">index&lt;/span> &lt;span class="s">index.html&lt;/span> &lt;span class="s">index.htm&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">expires&lt;/span> &lt;span class="s">30d&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">server&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">listen&lt;/span> &lt;span class="mi">80&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server_name&lt;/span> &lt;span class="s">cainiao2.com&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">location&lt;/span> &lt;span class="s">/&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">root&lt;/span> &lt;span class="s">/var/www/cainiao2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">index&lt;/span> &lt;span class="s">index.html&lt;/span> &lt;span class="s">index.htm&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">expires&lt;/span> &lt;span class="s">30d&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 重新加载配置
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">root@debian:~&lt;/span>&lt;span class="c1"># systemctl reload nginx.service
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="验证">验证
&lt;/h4>&lt;p>&lt;img src="https://caijemmy.github.io/p/2.0-nginx/image-nginx%E9%AA%8C%E8%AF%81%E5%90%8C%E4%B8%80%E7%AB%AF%E5%8F%A3%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%90%8C%E5%9F%9F%E5%90%8D1.png"
width="572"
height="190"
srcset="https://caijemmy.github.io/p/2.0-nginx/image-nginx%E9%AA%8C%E8%AF%81%E5%90%8C%E4%B8%80%E7%AB%AF%E5%8F%A3%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%90%8C%E5%9F%9F%E5%90%8D1_hu_9ef81a8ea03abcc5.png 480w, https://caijemmy.github.io/p/2.0-nginx/image-nginx%E9%AA%8C%E8%AF%81%E5%90%8C%E4%B8%80%E7%AB%AF%E5%8F%A3%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%90%8C%E5%9F%9F%E5%90%8D1_hu_2f2eab728184a085.png 1024w"
loading="lazy"
alt="image-nginx验证同一端口配置不同域名1"
class="gallery-image"
data-flex-grow="301"
data-flex-basis="722px"
>&lt;/p>
&lt;p>&lt;img src="https://caijemmy.github.io/p/2.0-nginx/image-nginx%E9%AA%8C%E8%AF%81%E5%90%8C%E4%B8%80%E7%AB%AF%E5%8F%A3%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%90%8C%E5%9F%9F%E5%90%8D2.png"
width="570"
height="182"
srcset="https://caijemmy.github.io/p/2.0-nginx/image-nginx%E9%AA%8C%E8%AF%81%E5%90%8C%E4%B8%80%E7%AB%AF%E5%8F%A3%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%90%8C%E5%9F%9F%E5%90%8D2_hu_9d1ee4e3255c9b18.png 480w, https://caijemmy.github.io/p/2.0-nginx/image-nginx%E9%AA%8C%E8%AF%81%E5%90%8C%E4%B8%80%E7%AB%AF%E5%8F%A3%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%90%8C%E5%9F%9F%E5%90%8D2_hu_9c5cd28373cbfc0e.png 1024w"
loading="lazy"
alt="image-nginx验证同一端口配置不同域名2"
class="gallery-image"
data-flex-grow="313"
data-flex-basis="751px"
>&lt;/p>
&lt;h3 id="不同域名指向同一访问路径">不同域名指向同一访问路径
&lt;/h3>&lt;h4 id="提前准备-1">提前准备
&lt;/h4>&lt;p>本地主机配置hosts文件&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">C:&lt;span class="se">\W&lt;/span>indows&lt;span class="se">\S&lt;/span>ystem32&lt;span class="se">\d&lt;/span>rivers&lt;span class="se">\e&lt;/span>tc&lt;span class="se">\h&lt;/span>osts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># nginx验证同一端口配置不同域名&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.52.60 cainiao1.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.52.60 cainiao2.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.52.60 xxoo.cainiao1.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.52.60 xx.cainiao1.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.52.60 oo.cainiao1.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.52.60 cainiao2.org
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">192.168.52.60 cainiao2.net
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="配置nginx-1">配置nginx
&lt;/h4>&lt;p>&lt;strong>注意：server_name配置域名时，域名间有空格&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="k">root@debian:~&lt;/span>&lt;span class="c1"># vim /etc/nginx/nginx.conf
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="s">server&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">listen&lt;/span> &lt;span class="mi">80&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># server_name cainiao1.com xxoo.cainiao1.com xx.cainiao1.com oo.cainiao1.com;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kn">server_name&lt;/span> &lt;span class="s">cainiao1.com&lt;/span> &lt;span class="s">*.cainiao1.com&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1"># 可以使用*通配符
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">location&lt;/span> &lt;span class="s">/&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">root&lt;/span> &lt;span class="s">/var/www/cainiao1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">index&lt;/span> &lt;span class="s">index.html&lt;/span> &lt;span class="s">index.htm&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">expires&lt;/span> &lt;span class="s">30d&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">server&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">listen&lt;/span> &lt;span class="mi">80&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server_name&lt;/span> &lt;span class="s">cainiao2.*&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">location&lt;/span> &lt;span class="s">/&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">root&lt;/span> &lt;span class="s">/var/www/cainiao2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">expires&lt;/span> &lt;span class="s">30d&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># 重新加载配置
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">root@debian:~&lt;/span>&lt;span class="c1"># systemctl reload nginx.service
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="验证-1">验证
&lt;/h4>&lt;p>&lt;img src="https://caijemmy.github.io/p/2.0-nginx/image-nginx%E9%AA%8C%E8%AF%81%E5%90%8C%E4%B8%80%E7%AB%AF%E5%8F%A3%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%90%8C%E5%9F%9F%E5%90%8D3.png"
width="647"
height="190"
srcset="https://caijemmy.github.io/p/2.0-nginx/image-nginx%E9%AA%8C%E8%AF%81%E5%90%8C%E4%B8%80%E7%AB%AF%E5%8F%A3%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%90%8C%E5%9F%9F%E5%90%8D3_hu_5adb1566d1e028e6.png 480w, https://caijemmy.github.io/p/2.0-nginx/image-nginx%E9%AA%8C%E8%AF%81%E5%90%8C%E4%B8%80%E7%AB%AF%E5%8F%A3%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%90%8C%E5%9F%9F%E5%90%8D3_hu_ca9e1cbf177d8203.png 1024w"
loading="lazy"
alt="image-nginx验证同一端口配置不同域名3"
class="gallery-image"
data-flex-grow="340"
data-flex-basis="817px"
>&lt;/p>
&lt;p>&lt;img src="https://caijemmy.github.io/p/2.0-nginx/image-nginx%E9%AA%8C%E8%AF%81%E5%90%8C%E4%B8%80%E7%AB%AF%E5%8F%A3%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%90%8C%E5%9F%9F%E5%90%8D4.png"
width="569"
height="181"
srcset="https://caijemmy.github.io/p/2.0-nginx/image-nginx%E9%AA%8C%E8%AF%81%E5%90%8C%E4%B8%80%E7%AB%AF%E5%8F%A3%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%90%8C%E5%9F%9F%E5%90%8D4_hu_77f85b634cbd8547.png 480w, https://caijemmy.github.io/p/2.0-nginx/image-nginx%E9%AA%8C%E8%AF%81%E5%90%8C%E4%B8%80%E7%AB%AF%E5%8F%A3%E9%85%8D%E7%BD%AE%E4%B8%8D%E5%90%8C%E5%9F%9F%E5%90%8D4_hu_24dfdfc5652a39a5.png 1024w"
loading="lazy"
alt="image-nginx验证同一端口配置不同域名4"
class="gallery-image"
data-flex-grow="314"
data-flex-basis="754px"
>&lt;/p>
&lt;h2 id="负载均衡参数详解">负载均衡参数详解
&lt;/h2>&lt;h3 id="nginx配置">nginx配置
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="k">root@debian:/opt/tomcat8082&lt;/span>&lt;span class="c1"># cat /etc/nginx/conf.d/default.conf
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="s">upstream&lt;/span> &lt;span class="s">myServers&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="n">127.0.0.1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">8081&lt;/span> &lt;span class="s">weight=4&lt;/span> &lt;span class="s">down&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="n">127.0.0.1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">8082&lt;/span> &lt;span class="s">weight=1&lt;/span> &lt;span class="s">backup&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server&lt;/span> &lt;span class="n">127.0.0.1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">8083&lt;/span> &lt;span class="s">weight=1&lt;/span> &lt;span class="s">max_fails=3&lt;/span> &lt;span class="s">fail_timeout=10s&lt;/span> &lt;span class="s">slow_start=30s&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">server&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">listen&lt;/span> &lt;span class="mi">80&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server_name&lt;/span> &lt;span class="s">localhost&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">location&lt;/span> &lt;span class="s">/&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># root /usr/share/nginx/html;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1"># index index.html index.htm;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kn">proxy_pass&lt;/span> &lt;span class="s">http://myServers&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">......&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>配置说明&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>&lt;strong>&lt;code>weight&lt;/code>&lt;/strong> 在实际生产中使用普遍，主要根据服务器配置、网络带宽对集群权重进行调整。权重越高，分配的请求越多。&lt;/li>
&lt;li>&lt;strong>&lt;code>down&lt;/code>&lt;/strong> 标记某个后端服务器为不可用状态，nginx不转发请求到此服务器。&lt;strong>实际中几乎不用&lt;/strong>。&lt;/li>
&lt;li>&lt;strong>&lt;code>backup&lt;/code>&lt;/strong> 用于将某台服务器标记为备用服务器。只有当所有非备用服务器不可用时，才会将请求分配到备用服务器。&lt;/li>
&lt;li>&lt;strong>&lt;code>max_fails&lt;/code> 和 &lt;code>fail_timeout&lt;/code>&lt;/strong> 在 &lt;code>fail_timeout&lt;/code> 时间窗口内允许的最大失败次数（&lt;code>max_fails&lt;/code>）。&lt;/li>
&lt;li>&lt;strong>&lt;code>resolve&lt;/code>&lt;/strong> 动态解析域名，适用于后端服务器使用域名的情况。&lt;/li>
&lt;li>&lt;strong>&lt;code>slow_start&lt;/code>&lt;/strong> 当服务器从 &lt;code>down&lt;/code> 状态恢复时，逐渐增加其权重。&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>顺序说明&lt;/strong>&lt;/p>
&lt;p>虽然 Nginx 的 &lt;code>upstream&lt;/code> 参数顺序不影响功能，但为了代码的规范性和可读性，建议按照以下顺序书写参数：&lt;/p>
&lt;ol>
&lt;li>服务器地址（IP 或域名）&lt;/li>
&lt;li>&lt;code>weight&lt;/code>&lt;/li>
&lt;li>&lt;code>max_fails&lt;/code> 和 &lt;code>fail_timeout&lt;/code>&lt;/li>
&lt;li>&lt;code>backup&lt;/code>&lt;/li>
&lt;li>&lt;code>down&lt;/code>&lt;/li>
&lt;li>其他参数（如 &lt;code>resolve&lt;/code>、&lt;code>slow_start&lt;/code> 等）&lt;/li>
&lt;/ol>
&lt;p>这样可以确保配置清晰易懂，便于后续维护和调试。&lt;/p>
&lt;h3 id="负载均衡算法">负载均衡算法
&lt;/h3>&lt;p>&lt;strong>实际配置情况&lt;/strong>&lt;/p>
&lt;p>&lt;strong>&lt;code>Round Robin（轮询）&lt;/code>&lt;/strong> 生产中使用这种，生产系统使用无状态会话技术即可。&lt;/p>
&lt;p>&lt;strong>&lt;code>Least Connections（最少连接）&lt;/code>&lt;/strong> 生产中不用，后端服务无法会话保持。&lt;/p>
&lt;p>&lt;strong>&lt;code>IP Hash&lt;/code>&lt;/strong> 生产中不用，移动端IP变化后，后端服务无法会话保持。&lt;/p>
&lt;p>&lt;strong>&lt;code>Generic Hash&lt;/code>&lt;/strong> url hash 定向流量转发，固定资源不在统一服务器，才用的到。&lt;strong>可能会出现流量偏移&lt;/strong>。&lt;/p>
&lt;p>&lt;strong>&lt;code>Random&lt;/code>&lt;/strong> 生产中不用，后端服务无法会话保持。&lt;/p>
&lt;h2 id="nginx-的正则表达式">Nginx 的正则表达式
&lt;/h2>&lt;p>Nginx 的正则表达式（Regular Expressions）主要用于 &lt;code>location&lt;/code> 块、&lt;code>rewrite&lt;/code> 指令、&lt;code>if&lt;/code> 条件等场景中，用于匹配 URL 或其他字符串。Nginx 使用的是 &lt;strong>PCRE（Perl Compatible Regular Expressions）&lt;/strong> 库，因此其语法与 Perl 的正则表达式兼容。&lt;/p>
&lt;h3 id="正则表达式的基本语法">正则表达式的基本语法
&lt;/h3>&lt;p>Nginx 的正则表达式语法与 PCRE 一致，以下是一些常用的元字符和语法：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>元字符&lt;/th>
&lt;th>描述&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>.&lt;/code>&lt;/td>
&lt;td>匹配任意单个字符（除换行符 &lt;code>\n&lt;/code> 外）&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>*&lt;/code>&lt;/td>
&lt;td>匹配前面的字符 0 次或多次&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>+&lt;/code>&lt;/td>
&lt;td>匹配前面的字符 1 次或多次&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>?&lt;/code>&lt;/td>
&lt;td>匹配前面的字符 0 次或 1 次&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>{n}&lt;/code>&lt;/td>
&lt;td>匹配前面的字符恰好 n 次&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>{n,}&lt;/code>&lt;/td>
&lt;td>匹配前面的字符至少 n 次&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>{n,m}&lt;/code>&lt;/td>
&lt;td>匹配前面的字符至少 n 次，至多 m 次&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>^&lt;/code>&lt;/td>
&lt;td>匹配字符串的开头&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>$&lt;/code>&lt;/td>
&lt;td>匹配字符串的结尾&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>\&lt;/code>&lt;/td>
&lt;td>转义字符，用于匹配特殊字符（如 &lt;code>.&lt;/code>、&lt;code>*&lt;/code> 等）&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>[]&lt;/code>&lt;/td>
&lt;td>字符集，匹配其中任意一个字符（如 &lt;code>[abc]&lt;/code> 匹配 &lt;code>a&lt;/code>、&lt;code>b&lt;/code> 或 &lt;code>c&lt;/code>）&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>[^]&lt;/code>&lt;/td>
&lt;td>否定字符集，匹配不在其中的任意字符（如 &lt;code>[^abc]&lt;/code> 匹配非 &lt;code>a&lt;/code>、&lt;code>b&lt;/code>、&lt;code>c&lt;/code> 的字符）&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>`&lt;/td>
&lt;td>`&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>()&lt;/code>&lt;/td>
&lt;td>分组，用于捕获匹配的内容或定义子表达式&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="nginx-中的正则表达式匹配">Nginx 中的正则表达式匹配
&lt;/h3>&lt;p>在 Nginx 中，正则表达式通常用于以下场景：&lt;/p>
&lt;h4 id="location">&lt;strong>&lt;code>location&lt;/code> 块中的正则匹配&lt;/strong>
&lt;/h4>&lt;p>&lt;code>location&lt;/code> 块可以使用正则表达式匹配 URL。正则表达式必须以 &lt;code>~&lt;/code>（区分大小写）或 &lt;code>~*&lt;/code>（不区分大小写）开头。&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>区分大小写匹配&lt;/strong>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="k">location&lt;/span> &lt;span class="p">~&lt;/span> &lt;span class="sr">\.php$&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 匹配以 .php 结尾的 URL
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;strong>不区分大小写匹配&lt;/strong>：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="k">location&lt;/span> &lt;span class="p">~&lt;/span>&lt;span class="sr">*&lt;/span> &lt;span class="s">\.(jpg|jpeg|png|gif)&lt;/span>$ &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 匹配以 .jpg、.jpeg、.png 或 .gif 结尾的 URL，不区分大小写
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;h4 id="rewrite">&lt;strong>&lt;code>rewrite&lt;/code> 指令中的正则匹配&lt;/strong>
&lt;/h4>&lt;p>&lt;code>rewrite&lt;/code> 指令可以使用正则表达式匹配 URL 并进行重写。&lt;/p>
&lt;ul>
&lt;li>
&lt;p>示例：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="k">rewrite&lt;/span> &lt;span class="s">^/old/(.*)&lt;/span>$ &lt;span class="s">/new/\&lt;/span>&lt;span class="nv">$1&lt;/span> &lt;span class="s">permanent&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>解释：&lt;/p>
&lt;ul>
&lt;li>&lt;code>^/old/(.*)$&lt;/code>：匹配以 &lt;code>/old/&lt;/code> 开头的 URL，并捕获后面的内容。&lt;/li>
&lt;li>&lt;code>/new/\$1&lt;/code>：将匹配的 URL 重写为 &lt;code>/new/&lt;/code> 加上捕获的内容。&lt;/li>
&lt;li>&lt;code>permanent&lt;/code>：返回 301 永久重定向。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h4 id="if">&lt;strong>&lt;code>if&lt;/code> 条件中的正则匹配&lt;/strong>
&lt;/h4>&lt;p>&lt;code>if&lt;/code> 指令可以使用正则表达式进行条件判断。&lt;/p>
&lt;ul>
&lt;li>
&lt;p>示例：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="s">(&lt;/span>&lt;span class="nv">$request_uri&lt;/span> &lt;span class="p">~&lt;/span>&lt;span class="sr">*&lt;/span> &lt;span class="s">&amp;#34;^/admin&amp;#34;)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">return&lt;/span> &lt;span class="mi">403&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>解释：&lt;/p>
&lt;ul>
&lt;li>如果请求的 URL 以 &lt;code>/admin&lt;/code> 开头（不区分大小写），则返回 403 状态码。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="正则表达式的捕获与引用">正则表达式的捕获与引用
&lt;/h3>&lt;p>在 Nginx 中，正则表达式的捕获内容可以通过 &lt;code>\$1&lt;/code>、&lt;code>\$2&lt;/code> 等变量引用。&lt;/p>
&lt;ul>
&lt;li>
&lt;p>示例：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="k">location&lt;/span> &lt;span class="p">~&lt;/span> &lt;span class="sr">^/user/(\d+)$&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_pass&lt;/span> &lt;span class="s">http://backend/user/\&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>解释：&lt;/p>
&lt;ul>
&lt;li>&lt;code>(\d+)&lt;/code>：捕获 URL 中的数字部分。&lt;/li>
&lt;li>&lt;code>\$1&lt;/code>：引用捕获的内容。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="综合示例">综合示例
&lt;/h3>&lt;p>以下是一个综合示例，展示了正则表达式在 Nginx 中的使用：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-nginx" data-lang="nginx">&lt;span class="line">&lt;span class="cl">&lt;span class="k">server&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">listen&lt;/span> &lt;span class="mi">80&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">server_name&lt;/span> &lt;span class="s">example.com&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 匹配以 /user/ 开头的 URL，并捕获用户 ID
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kn">location&lt;/span> &lt;span class="p">~&lt;/span> &lt;span class="sr">^/user/(\d+)$&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">proxy_pass&lt;/span> &lt;span class="s">http://backend/user/\&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 匹配以 .jpg、.jpeg、.png 或 .gif 结尾的 URL，不区分大小写
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kn">location&lt;/span> &lt;span class="p">~&lt;/span>&lt;span class="sr">*&lt;/span> &lt;span class="s">\.(jpg|jpeg|png|gif)&lt;/span>$ &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">access_log&lt;/span> &lt;span class="no">off&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">expires&lt;/span> &lt;span class="s">30d&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 重写 /old/ 开头的 URL 到 /new/
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kn">rewrite&lt;/span> &lt;span class="s">^/old/(.*)&lt;/span>$ &lt;span class="s">/new/\&lt;/span>&lt;span class="nv">$1&lt;/span> &lt;span class="s">permanent&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># 如果请求的 URL 以 /admin 开头，返回 403
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kn">if&lt;/span> &lt;span class="s">(&lt;/span>&lt;span class="nv">$request_uri&lt;/span> &lt;span class="p">~&lt;/span>&lt;span class="sr">*&lt;/span> &lt;span class="s">&amp;#34;^/admin&amp;#34;)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kn">return&lt;/span> &lt;span class="mi">403&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item></channel></rss>